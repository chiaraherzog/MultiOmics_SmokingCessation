w---
title: "Metabolome data (F4, S5)"
format:
  html:
    toc: true
    code-fold: true
    code-overflow: wrap
    code-tools: true
---

# Figures

::: {.panel-tabset} 

## Main figure 4

![](figures-png/figure4.png)

## Supplementary Figure 4

![](figures-png/e4.png)

:::

# Code

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, eval = F)

# libraries
library(dplyr)
library(ggplot2)
library(patchwork)
library(ggtext)
library(here)
library(ggrepel)
library(broom)
library(ComplexHeatmap)
library(MultiAssayExperiment)
library(RColorBrewer)
library(viridis)

library(missMDA)
library(factoextra)
library(FactoMineR)

# colours
cols <- c("#1b69a1", "#48a0af", "#71b5a9", "#ec6669", "#f39668", "#bd647d", "#832c9b", "#5f70a8")

# functions
source("src/filter_smk.R")
source("src/paired_longitudinal_compliance.R")
source("src/lmm.R")
source("src/plot_heatmap_Metab.R")
source("src/longitudinal.R")
source("src/comparison_plots.R")

source(here("src/pca.R"))
source(here("src/pcaBiplot.R"))
source(here("src/pcaHeatmap.R"))

# path
here::i_am("fig4-metab.qmd")
```

```{r data}
# Load Wilcox test data
load(here("out/wilcoxon-tests.Rdata"))

# Load annotation of metabolites
ref_saliva <-  readRDS("out/RefMet_mapped_saliva.Rds")
ref_urine <-  readRDS("out/RefMet_mapped_urine.Rds")
```

## Main figure 

### 4a) Saliva heatmap (Wilcoxon tests)

```{r saliva.heatmap}
labels <- ref_saliva |> 
  dplyr::rename(x = Input.name,
                label = Standardized.name,
                assay2 = Super.class) |> 
  dplyr::select(x, label, assay2) |> 
  dplyr::mutate(assay = 'Saliva nuclear magnetic resonance: normalized',
                x = ifelse(grepl("^[[:digit:]]", x), paste0("X", x), x),
                x = ifelse(x == "Acetate.", "Acetate.mM.", x),
                x = ifelse(x == 'Trimethylamine N-oxide', 'TMA..N.oxide', x))

load(here("out/wilcoxon-tests.Rdata"))
time <- wilcoxon_tests$overall |> 
  tidyr::separate(rowname, "_", into = c("assay", "variable"), extra = 'merge') |> 
  dplyr::filter(grepl("Saliva", assay) & grepl("normalized", assay))


comp <- wilcoxon_tests$`compliance comparison` |> 
  tidyr::separate(rowname, "_", into = c("assay", "variable"), extra = 'merge') |> 
  dplyr::filter(grepl("Saliva", assay) & grepl("normalized", assay))

saliva_heatmap <- plot_heatmap_Metab(time,
                                     comp,
                                     relabel = labels, 
                   cluster = 'default',
                   change_baseline = T)
```


```{r}
cairo_pdf(here("out/pdf/4a.pdf"), width = 5.75, height = 3)
print(saliva_heatmap)
dev.off()
```

```{r sourcedata.saliva.heatmap}
out <- saliva_heatmap@matrix
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4a.txt')
```


### 4b) Hyroxyacetone

```{r}
load(here("data/data_normalized_baseline.Rdata"))

df <- longForm(data[,,40], colDataCols = c("interventionId", "subjectId", "visitId", "time", "compliance")) |>
  as.data.frame() |>
  dplyr::filter(interventionId == 'S' & ! visitId %in% c("M12", "M18")) |>
  dplyr::mutate(compliance = factor(compliance, levels = c("lower compliance", "higher compliance"))) |>
  dplyr::filter(!is.na(value))

hydroxy <- longitudinal(df, variable = 'Hydroxyacetone', p = 'p.signif',
             ylab = '<b>∆ Hydroxyacetone</b><br>(saliva; normalized)')
```

```{r}
cairo_pdf(here("out/pdf/4b.pdf"), width = 2, height = 3)
print(hydroxy)
dev.off()
```

```{r sourcedata.hydroxy}
out <-  hydroxy$data |> dplyr::select(visitId, subjectId, value) |> 
  dplyr::group_by(subjectId) |> dplyr::mutate(id = dplyr::cur_group_id()) |> dplyr::ungroup() |> dplyr::select(-subjectId)

out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4b.txt')
```

### 4c) Acetoin

```{r}
acetoin <- longitudinal(df, variable = 'Acetoin', p = 'p.signif',
             ylab = '<b>∆ Acetoin</b><br>(saliva; normalized)')
cairo_pdf(here("out/pdf/4c.pdf"), width = 2, height = 3)
acetoin
dev.off()
```


```{r sourcedata.acetoin}
out <-  acetoin$data |> dplyr::select(visitId, subjectId, value) |> 
  dplyr::group_by(subjectId) |> dplyr::mutate(id = dplyr::cur_group_id()) |> dplyr::ungroup() |> dplyr::select(-subjectId)

out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4c.txt')
```

### 4d) Thymine

```{r}
cairo_pdf(here("out/pdf/4d.pdf"), width = 2, height = 3)
(thymine <- longitudinal(df, variable = 'Thymine', p = 'p.signif',
             ylab = '<b>∆ Thymine</b><br>(saliva; normalized)'))
dev.off()
```

```{r sourcedata.thymine}
out <-  thymine$data |> dplyr::select(visitId, subjectId, value) |> 
  dplyr::group_by(subjectId) |> dplyr::mutate(id = dplyr::cur_group_id()) |> dplyr::ungroup() |> dplyr::select(-subjectId)

out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4d.txt')
```

### 4e) Lysine

```{r}
cairo_pdf(here("out/pdf/4e.pdf"), width = 2, height = 3)
(lysine <- longitudinal(df, variable = 'Lysine', p = 'p.signif',
             ylab = '<b>∆ Lysine</b><br>(saliva; normalized)'))
dev.off()
```

```{r sourcedata.lysine}
out <-  lysine$data |> dplyr::select(visitId, subjectId, value) |> 
  dplyr::group_by(subjectId) |> dplyr::mutate(id = dplyr::cur_group_id()) |> dplyr::ungroup() |> dplyr::select(-subjectId)

out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4e.txt')
```


### f) Urine heatmap (t tests)

```{r urine.heatmap}
labels <- ref_urine |> 
  dplyr::rename(x = Input.name,
                label = Standardized.name,
                assay2 = Super.class) |> 
  dplyr::select(x, label, assay2) |> 
  dplyr::mutate(assay = 'Urine nuclear magnetic resonance: normalized',
                x = ifelse(grepl("^[[:digit:]]", x), paste0("X", x), x),
                x = ifelse(x == "Acetate.", "Acetate.mM.", x),
                x = ifelse(x == 'Trimethylamine N-oxide', 'TMA..N.oxide', x))

time <- wilcoxon_tests$overall |> 
  tidyr::separate(rowname, "_", into = c("assay", "variable"), extra = 'merge') |> 
  dplyr::filter(grepl("Urine", assay) & grepl("normalized", assay))

comp <- wilcoxon_tests$`compliance comparison` |> 
  tidyr::separate(rowname, "_", into = c("assay", "variable"), extra = 'merge') |> 
  dplyr::filter(grepl("Urine", assay) & grepl("normalized", assay))


urine_heatmap <- plot_heatmap_Metab(time, comp,
                                    relabel = labels, 
                   cluster = 'default',
                   change_baseline = F)
```

```{r print.urine.heatmap}
cairo_pdf(here("out/pdf/4g.pdf"), width = 5.5, height = 3)
print(urine_heatmap)
dev.off()
```

```{r sourcedata.urine}
out <-  urine_heatmap@matrix
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4f.txt')
```

### 4g) Lactate 

```{r}
load(here("data/data_normalized_baseline.Rdata"))

df <- longForm(data[,,11], colDataCols = c("interventionId", "subjectId", "visitId", "time", "compliance")) |>
  as.data.frame() |>
  dplyr::filter(interventionId == 'S' & ! visitId %in% c("M12", "M18")) |>
  dplyr::mutate(compliance = factor(compliance, levels = c("lower compliance", "higher compliance"))) |>
  dplyr::filter(!is.na(value))
```


```{r}
cairo_pdf(here("out/pdf/4g.pdf"), width = 5.5, height = 3)
(lact <- longitudinal(df, variable = 'Lactate', p = 'p.signif',
             ylab = '<b>∆ Lactate</b><br>(urine; normalized)'))
dev.off()
```

```{r sourcedata.lact}
out <-  lact$data |> dplyr::select(visitId, subjectId, value) |> 
  dplyr::group_by(subjectId) |> dplyr::mutate(id = dplyr::cur_group_id()) |> dplyr::ungroup() |> dplyr::select(-subjectId)

out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4g.txt')
```

### 4g) Choline 

```{r}
cairo_pdf(here("out/pdf/4g.pdf"), width = 2, height = 3)
(chol <- longitudinal(df, variable = 'Choline', p = 'p.signif',
             ylab = '<b>∆ Choline</b><br>(urine; normalized)'))
dev.off()
```

```{r sourcedata.chol}
out <-  chol$data |> dplyr::select(visitId, subjectId, value) |> 
  dplyr::group_by(subjectId) |> dplyr::mutate(id = dplyr::cur_group_id()) |> dplyr::ungroup() |> dplyr::select(-subjectId)

out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4h.txt')
```


### 4i) Trimethylamine 

```{r}
cairo_pdf(here("out/pdf/4i.pdf"), width = 2, height = 3)
(trim <- longitudinal(df, variable = 'Trimethylamine', p = 'p.signif',
             ylab = '<b>∆ Trimethylamine</b><br>(urine; normalized)'))
dev.off()
```

```{r sourcedata.trim}
out <-  trim$data |> dplyr::select(visitId, compliance, subjectId, value) |> 
  dplyr::group_by(subjectId) |> dplyr::mutate(id = dplyr::cur_group_id()) |> dplyr::ungroup() |> dplyr::select(-subjectId)

out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4i.txt')
```


### 4k) Betaine 

```{r}
cairo_pdf(here("out/pdf/4k.pdf"), width = 2, height = 3)
(beta <- longitudinal(df, variable = 'Betaine', p = 'p.signif',
             ylab = '<b>∆ Betaine</b><br>(urine; normalized)'))
dev.off()
```

```{r sourcedata.beta}
out <-  beta$data |> dplyr::select(visitId, subjectId, value) |> 
  dplyr::group_by(subjectId) |> dplyr::mutate(id = dplyr::cur_group_id()) |> dplyr::ungroup() |> dplyr::select(-subjectId)

out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/4j.txt')
```



## Supplementary

### Saliva PCA

```{r saliva.pca}
experiment <- c("Saliva nuclear magnetic resonance: normalized")
features <- c("subjectId", "visitId", "time", "compliance", "smoking_py", "cig_curr", "mpstatrs", "age_at_consent", "bmi_at_consent", "etohu_curr", "diet")
load(here("data/data_raw.Rdata"))

ref_saliva <-  readRDS("out/RefMet_mapped_saliva.Rds")
relabel <- ref_saliva |> 
  dplyr::mutate(x = case_when(Input.name == 'Acetate.' ~ 'Acetate.mM.',
                                       Input.name == '3.Methyl.2.oxovalerate' ~ 'X3.Methyl.2.oxovalerate',
                                       Input.name == '5.Aminopentanoate' ~ 'X5.Aminopentanoate',
                                       Input.name == 'Trimethylamine N-oxide' ~ 'TMA..N.oxide',
                                       TRUE ~ Input.name)) |> 
  dplyr::rename(label = Standardized.name)

pc_saliva <- pca(data,
    experiment, features, relabel = relabel)

# perc of variance explained by first 5:
pc_saliva$pc.object$eig[5,3]
```

#### 3a) Saliva scree plot

```{r print.saliva.scree}
cairo_pdf(here("out/pdf/e4a.pdf"),
          width = 1.5, height = 3)
print(pc_saliva$scree)
dev.off()
```

```{r sourcedata.scree}
out <-  pc_saliva$scree$data
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/s5a.txt')
```


#### 3b) Saliva PCA heatmap

```{r print.saliva.pca.heatmap}
cairo_pdf(here("out/pdf/e4b.pdf"),
          width = 3.5, height = 3)
print(pc_saliva$heatmap)
dev.off()
```

```{r sourcedata.hm}
out <-  pc_saliva$heatmap@matrix
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/s5b.txt')
```

### Urine PCA

```{r urine.pca}
experiment <- c("Urine nuclear magnetic resonance: normalized")
features <- c("subjectId", "visitId", "time", "compliance", "smoking_py", "cig_curr", "mpstatrs", "age_at_consent", "bmi_at_consent", "etohu_curr", "diet")
load(here("data/data_raw.Rdata"))
ref_urine <-  readRDS("out/RefMet_mapped_urine.Rds")
relabel <- ref_urine |> 
  dplyr::rename(x = Input.name,
                label = Standardized.name,
                assay2 = Super.class) |> 
  dplyr::select(x, label, assay2) |> 
  dplyr::mutate(assay = 'Urine nuclear magnetic resonance: normalized',
                x = ifelse(grepl("^[[:digit:]]", x), paste0("X", x), x),
                x = ifelse(x == "Acetate.", "Acetate.mM.", x),
                x = ifelse(x == 'Trimethylamine N-oxide', 'TMA..N.oxide', x))

pc_urine <- pca(data, experiment, features, relabel = relabel)
# perc of variance explained by first 5:
pc_urine$pc.object$eig[5,3]
```

#### 3c) Urine scree plot

```{r prine.urine.scree}
cairo_pdf(here("out/pdf/e4c.pdf"),
          width = 1.5, height = 3)
print(pc_urine$scree)
dev.off()
```


```{r sourcedata.scree.urine}
out <-  pc_urine$scree$data
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/s5c.txt')
```

#### 3d) Urine: PCA - Heatmap

```{r print.urine.pca.heatmap}
cairo_pdf(here("out/pdf/e4d.pdf"),
          width = 3.5, height = 3)
print(pc_urine$heatmap)
dev.off()
```


```{r sourcedata.hm}
out <-  pc_urine$heatmap@matrix
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/s5d.txt')
```


### Saliva association with smoking pack years at baseline (histogram and volcano plot) [not shown]

```{r}
# Filter corr
load(here("out/corrSPYbaseline.Rdata"))

labels <- ref_saliva |> 
  dplyr::rename(x = Input.name,
                label = Standardized.name,
                assay2 = Super.class) |> 
  dplyr::select(x, label, assay2) |> 
  dplyr::mutate(assay = 'Saliva nuclear magnetic resonance: normalized',
                x = ifelse(grepl("^[[:digit:]]", x), paste0("X", x), x),
                x = ifelse(x == "Acetate.", "Acetate.mM.", x),
                x = ifelse(x == 'Trimethylamine N-oxide', 'TMA..N.oxide', x))

corr <- corr |> 
  tidyr::separate(rowname, "_", into = c("assay", "x"), extra = 'merge')  |> 
  dplyr::filter(assay == 'Saliva nuclear magnetic resonance: normalized') |> 
  dplyr::left_join(labels)

# Histogram
hist <- corr |>
  ggplot(aes(x = p)) +
  geom_histogram(bins = 10,
                 # alpha = 0.5,
                 colour = 'black',fill = 'grey60') +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  labs(x = 'p value',
       y = 'n')

saliva.corr.volcano <- corr |> 
  dplyr::mutate(padj = p.adjust(p, method = 'holm'),
                lab = ifelse(padj < 0.05, label, NA),
                lab2 = ifelse(p<0.05, label, NA)) |> 
  ggplot(aes(x = cor,
             y = as.numeric(-log10(p)),
             size = as.numeric(-log10(p)),
             colour = as.numeric(-log10(p)))) +
  geom_point(alpha = 0.7) +
  scale_size_continuous(range = c(1, 3.5)) +
  scale_colour_viridis_c(option = 'G',end = 0.8,
                         name = '-log10(p)') +
  ggrepel::geom_text_repel(aes(label = lab2)) +
  theme_bw() +
  labs(x = 'Correlation', y = '-log10(p value)') +
  coord_cartesian(clip = 'off',
                  xlim = c(-0.5, 0.5)) +
  guides(size = 'none')
```

### 3e) Saliva association with cig_curr at baseline, histogram

```{r}
# Filter corr
load(here("out/corrCigBaseline.Rdata"))

labels <- ref_saliva |> 
  dplyr::rename(x = Input.name,
                label = Standardized.name,
                assay2 = Super.class) |> 
  dplyr::select(x, label, assay2) |> 
  dplyr::mutate(assay = 'Saliva nuclear magnetic resonance: normalized',
                x = ifelse(grepl("^[[:digit:]]", x), paste0("X", x), x),
                x = ifelse(x == "Acetate.", "Acetate.mM.", x),
                x = ifelse(x == 'Trimethylamine N-oxide', 'TMA..N.oxide', x))

corr <- corr |> 
  tidyr::separate(rowname, "_", into = c("assay", "x"), extra = 'merge')  |> 
  dplyr::filter(assay == 'Saliva nuclear magnetic resonance: normalized') |> 
  dplyr::left_join(labels)

# Histogram
hist <- corr |>
  ggplot(aes(x = p)) +
  geom_histogram(bins = 10,
                 # alpha = 0.5,
                 colour = 'black',fill = 'grey60') +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  labs(x = 'p value',
       y = 'n')
```

```{r print.hist.saliva}
cairo_pdf(here("out/pdf/e4e.pdf"), width = 2.5, height = 3)
print(hist)
dev.off()
```

```{r sourcedata.hist.saliva}
out <- hist$data
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/s5e.txt')
```


### 3f) Saliva association with cig_curr at baseline, volcano plot

```{r}
saliva.corr.volcano <- corr |> 
  dplyr::mutate(padj = p.adjust(p, method = 'holm'),
                lab = ifelse(padj < 0.05, label, NA),
                lab2 = ifelse(p<0.05, label, NA)) |> 
  ggplot(aes(x = cor,
             y = as.numeric(-log10(p)),
             size = as.numeric(-log10(p)),
             colour = as.numeric(-log10(p)))) +
  geom_point(alpha = 0.7) +
  scale_size_continuous(range = c(1, 3.5)) +
  scale_colour_viridis_c(option = 'G',end = 0.8,
                         name = '-log10(p)') +
  ggrepel::geom_text_repel(aes(label = lab2)) +
  theme_bw() +
  labs(x = 'Correlation', y = '-log10(p value)') +
  coord_cartesian(clip = 'off',
                  xlim = c(-0.5, 0.5)) +
  guides(size = 'none')
```

```{r print.volcano.saliva}
cairo_pdf(here("out/pdf/e4f.pdf"), width = 4.5, height = 3)
print(saliva.corr.volcano)
dev.off()
```


```{r sourcedata.volc.saliva}
out <- saliva.corr.volcano$data
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/s5f.txt')
```



 
### Urine association with smoking at baseline, histogram [not shown]

```{r}
# Filter corr
load(here("out/corrCigBaseline.Rdata"))

corr <- corr |> 
  tidyr::separate(rowname, "_", into = c("assay", "x"), extra = 'merge')  |> 
  dplyr::filter(assay == 'Urine nuclear magnetic resonance: normalized') |> 
  dplyr::left_join(labels)

# Histogram
hist.urine <- corr |>
  ggplot(aes(x = p)) +
  geom_histogram(bins = 10,
                 # alpha = 0.5,
                 colour = 'black',fill = 'grey60') +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  labs(x = 'p value',
       y = 'n')
```

### Urine association with smoking at baseline, volcano plot [not shown]

```{r}
urine.corr.volcano <- corr |> 
  dplyr::mutate(padj = p.adjust(p, method = 'holm'),
                lab = ifelse(padj < 0.05, label, NA),
                lab2 = ifelse(p<0.05, label, NA))  |> 
  ggplot(aes(x = cor,
             y = as.numeric(-log10(p)),
             size = as.numeric(-log10(p)),
             colour = as.numeric(-log10(p)))) +
  geom_point(alpha = 0.7) +
  scale_size_continuous(range = c(1, 3.5)) +
  scale_colour_viridis_c(option = 'G',end = 0.8,
                         name = '-log10(p)') +
  ggrepel::geom_text_repel(aes(label = lab2)) +
  theme_bw() +
  labs(x = 'Correlation', y = '-log10(p value)') +
  coord_cartesian(clip = 'off',
                  xlim = c(-0.5, 0.5)) +
  guides(size = 'none')
```

### 3g) Urine association with cumulative smoking (histogram and volcano plot)

```{r}
# Filter corr
load(here("out/corrSPYbaseline.Rdata"))

corr <- corr |> 
  tidyr::separate(rowname, "_", into = c("assay", "x"), extra = 'merge')  |> 
  dplyr::filter(assay == 'Urine nuclear magnetic resonance: normalized') |> 
  dplyr::left_join(labels)

# Histogram
hist.urine <- corr |>
  ggplot(aes(x = p)) +
  geom_histogram(bins = 10,
                 # alpha = 0.5,
                 colour = 'black',fill = 'grey60') +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  labs(x = 'p value',
       y = 'n')
```

```{r print.hist.urine}
cairo_pdf(here("out/pdf/e4g.pdf"), width = 2.5, height = 3)
print(hist.urine)
dev.off()
```


```{r sourcedata.volc.urine}
out <- hist.urine$data
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/s5g.txt')
```

### 3g) Urine association with cumulative smoking (histogram and volcano plot)


```{r}
urine.corr.volcano <- corr |> 
  dplyr::mutate(padj = p.adjust(p, method = 'holm'),
                lab = ifelse(p < 0.05, x, NA),
                lab2 = ifelse(p<0.05, label, NA)) |> 
  ggplot(aes(x = cor,
             y = as.numeric(-log10(p)),
             size = as.numeric(-log10(p)),
             colour = as.numeric(-log10(p)))) +
  geom_point(alpha = 0.7) +
  scale_size_continuous(range = c(1, 3.5)) +
  scale_colour_viridis_c(option = 'G',end = 0.8,
                         name = '-log10(p)') +
  ggrepel::geom_text_repel(aes(label = lab)) +
  theme_bw() +
  labs(x = 'Correlation', y = '-log10(p value)') +
  coord_cartesian(clip = 'off',
                  xlim = c(-0.5, 0.5)) +
  guides(size = 'none')
```

```{r print.volcano.urine}
cairo_pdf(here("out/pdf/e4h.pdf"), width = 4.5, height = 3)
print(urine.corr.volcano)
dev.off()
```


```{r sourcedata.volc.saliva}
out <- urine.corr.volcano$data
out |> write.table(quote = F, sep = "\t", row.names = F, col.names = T,
                   file = 'srcdata/s5h.txt')
```
